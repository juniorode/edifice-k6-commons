(function(e,n){typeof exports=="object"&&typeof module<"u"?n(exports,require("k6/http"),require("k6")):typeof define=="function"&&define.amd?define(["exports","k6/http","k6"],n):(e=typeof globalThis<"u"?globalThis:e||self,n(e["edifice-k6-commons"]={},e.http,e.k6))})(this,function(e,n,c){"use strict";var A=Object.defineProperty;var E=(e,n,c)=>n in e?A(e,n,{enumerable:!0,configurable:!0,writable:!0,value:c}):e[n]=c;var f=(e,n,c)=>(E(e,typeof n!="symbol"?n+"":n,c),c);const l={COOKIE:0,OAUTH2:1};class k{constructor(s,o,r,i){f(this,"expiresAt");f(this,"token");f(this,"mode");f(this,"cookies");this.token=s,this.mode=o,this.cookies=i,this.expiresAt=Date.now()+r*1e3-3e3}isExpired(){return this.expiresAt<=Date.now()}getCookie(s){return this.cookies?this.cookies.filter(o=>o.name===s).map(o=>o.value)[0]:null}}const g=__ENV.BASE_URL,S=30*60,h=__ENV.ROOT_URL,d=function(t){let s;return t?t.mode===l.COOKIE?s={"x-xsrf-token":t.getCookie("XSRF-TOKEN")||""}:t.mode===l.OAUTH2?s={Authorization:`Bearer ${t.token}`}:s={}:s={},s},m=function(t,s){const o=n.get(`${h}/conversation/visible?search=${t}`,{headers:d(s)});return c.check(o,{"should get an OK response":i=>i.status==200}),o.json("users")[0].id},_=function(t){const s=n.get(`${h}/auth/oauth2/userinfo`,{headers:d(t)});return c.check(s,{"should get an OK response":o=>o.status==200,"should get a valid userId":o=>!!o.json("userId")}),s.json("userId")},I=function(t,s){let o={email:t,password:s,callBack:"",detail:""};const r=n.post(`${h}/auth/login`,o,{redirects:0});c.check(r,{"should redirect connected user to login page":u=>u.status===302,"should have set an auth cookie":u=>u.cookies.oneSessionId!==null&&u.cookies.oneSessionId!==void 0}),n.cookieJar().set(h,"oneSessionId",r.cookies.oneSessionId[0].value);const a=Object.keys(r.cookies).map(u=>({name:u,value:r.cookies[u][0].value}));return new k(r.cookies.oneSessionId[0].value,l.COOKIE,S,a)},U=function(t,s,o,r){let i={grant_type:"password",username:t,password:s,client_id:o,client_secret:r,scope:"timeline userbook blog lvs actualites pronote schoolbook support viescolaire zimbra conversation directory homeworks userinfo workspace portal cas sso presences incidents competences diary edt infra auth"},a=n.post(`${h}/auth/oauth2/token`,i,{redirects:0});c.check(a,{"should get an OK response for authentication":p=>p.status==200,"should have set an access token":p=>!!p.json("access_token")});const u=a.json("access_token");return new k(u,l.OAUTH2,a.json("expires_in"))},y=function(t,s){const o=n.get(`${g}/metrics`,{headers:d(s)});c.check(o,{"should get an OK response":i=>i.status==200});const r=o.body.split(`
`);for(let i of r)if(i.indexOf(`${t} `)===0)return parseFloat(i.substring(t.length+1).trim());return console.error("Metric",t,"not found"),null},O=__ENV.ROOT_URL;function b(t,s){let o=n.get(`${O}/directory/api/ecole`,{headers:d(s)});const r=JSON.parse(o.body).result;return Object.keys(r||{}).map(a=>r[a]).filter(a=>a.name===t)[0]}function v(t,s){let o=n.get(`${O}/directory/structure/${t.id}/users`,{headers:d(s)});if(o.status!==200)throw`Impossible to get users of ${t.id}`;return JSON.parse(o.body)}e.BASE_URL=g,e.Session=k,e.SessionMode=l,e.authenticateOAuth2=U,e.authenticateWeb=I,e.getConnectedUserId=_,e.getHeaders=d,e.getMetricValue=y,e.getSchoolByName=b,e.getUsersOfSchool=v,e.searchUser=m,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});
