(function(s,c){typeof exports=="object"&&typeof module<"u"?c(exports,require("k6/http"),require("k6"),require("https://jslib.k6.io/formdata/0.0.2/index.js"),require("https://jslib.k6.io/url/1.0.0/index.js")):typeof define=="function"&&define.amd?define(["exports","k6/http","k6","https://jslib.k6.io/formdata/0.0.2/index.js","https://jslib.k6.io/url/1.0.0/index.js"],c):(s=typeof globalThis<"u"?globalThis:s||self,c(s["edifice-k6-commons"]={},s.http,s.k6,s.index_js$1,s.index_js))})(this,function(s,c,i,S,A){"use strict";var ue=Object.defineProperty;var de=(s,c,i)=>c in s?ue(s,c,{enumerable:!0,configurable:!0,writable:!0,value:i}):s[c]=i;var y=(s,c,i)=>(de(s,typeof c!="symbol"?c+"":c,i),i);const m={COOKIE:0,OAUTH2:1};class O{constructor(o,r,t,n){y(this,"expiresAt");y(this,"token");y(this,"mode");y(this,"cookies");this.token=o,this.mode=r,this.cookies=n,this.expiresAt=Date.now()+t*1e3-3e3}isExpired(){return this.expiresAt<=Date.now()}getCookie(o){return this.cookies?this.cookies.filter(r=>r.name===o).map(r=>r.value)[0]:null}}const W=__ENV.BASE_URL,j=30*60,k=__ENV.ROOT_URL,u=function(e){let o;return e?e.mode===m.COOKIE?o={"x-xsrf-token":e.getCookie("XSRF-TOKEN")||""}:e.mode===m.OAUTH2?o={Authorization:`Bearer ${e.token}`}:o={}:o={},o},I=function(e,o){const r=c.get(`${k}/conversation/visible?search=${e}`,{headers:u(o)});return i.check(r,{"should get an OK response":n=>n.status==200}),r.json("users")[0].id},D=function(e){const o=c.get(`${k}/auth/oauth2/userinfo`,{headers:u(e)});return i.check(o,{"should get an OK response":r=>r.status==200,"should get a valid userId":r=>!!r.json("userId")}),o.json("userId")},N=function(e,o){let r={email:e,password:o,callBack:"",detail:""};const t=c.post(`${k}/auth/login`,r,{redirects:0});i.check(t,{"should redirect connected user to login page":l=>l.status===302,"should have set an auth cookie":l=>l.cookies.oneSessionId!==null&&l.cookies.oneSessionId!==void 0}),c.cookieJar().set(k,"oneSessionId",t.cookies.oneSessionId[0].value);const a=Object.keys(t.cookies).map(l=>({name:l,value:t.cookies[l][0].value}));return new O(t.cookies.oneSessionId[0].value,m.COOKIE,j,a)},B=function(e){return c.cookieJar().set(k,"oneSessionId",e.token),e},J=function(e,o,r,t){let n={grant_type:"password",username:e,password:o,client_id:r,client_secret:t,scope:"timeline userbook blog lvs actualites pronote schoolbook support viescolaire zimbra conversation directory homeworks userinfo workspace portal cas sso presences incidents competences diary edt infra auth"},a=c.post(`${k}/auth/oauth2/token`,n,{redirects:0});i.check(a,{"should get an OK response for authentication":d=>d.status==200,"should have set an access token":d=>!!d.json("access_token")});const l=a.json("access_token");return new O(l,m.OAUTH2,a.json("expires_in"))};function F(e,o){const r=(o||[]).map(t=>t.id);for(let t=0;t<1e3;t++){const n=e[Math.floor(Math.random()*e.length)];if(r.indexOf(n.id)<0)return n}throw"cannot.find.random.user"}const G=function(e,o){const r=c.get(`${W}/metrics`,{headers:u(o)});i.check(r,{"should get an OK response":n=>n.status==200});const t=r.body.split(`
`);for(let n of t)if(n.indexOf(`${e} `)===0)return parseFloat(n.substring(e.length+1).trim());return console.error("Metric",e,"not found"),null},f=__ENV.ROOT_URL,L=new A.URL(f).hostname;function h(e,o){let r=c.get(`${f}/directory/structure/admin/list`,{headers:u(o)});return JSON.parse(r.body).filter(t=>t.name===e)[0]}function V(e,o){let r=c.get(`${f}/directory/structure/${e.id}/users`,{headers:u(o)});if(r.status!==200)throw`Impossible to get users of ${e.id}`;return JSON.parse(r.body)}function H(e,o){let r=c.get(`${f}/directory/structure/${e.id}/users`,{headers:u(o)});r.status!=200&&i.fail(`Cannot fetch users of structure ${e.id} : ${r}`);const t=JSON.parse(r.body);for(let n=0;n<t.length;n++){const a=t[n];_(a)}}function _(e){if(e.code){const o={};o.login=e.login,o.activationCode=e.code,o.password="password",o.confirmPassword="password",o.acceptCGU="true";const r=c.post(`${f}/auth/activation`,o,{redirects:0,headers:{Host:L}});r.status!==302&&(console.error(r),i.fail(`Could not activate user ${e.login} : ${r.status} - ${r.body}`))}}function M(e,o,r,t){const a=b(e.id,t).filter(l=>r.indexOf(l.name)>=0);for(let l of a)if(l.roles.indexOf(o.name)>=0)console.log("Role already attributed to teachers");else{const d=u(t);d["content-type"]="application/json";const g={headers:d},p=JSON.stringify({groupId:l.id,roleIds:(l.roles||[]).concat([o.id])}),E=c.post(`${f}/appregistry/authorize/group?schoolId=${e.id}`,p,g);i.check(E,{"link role to structure":ie=>ie.status==200})}}function P(e,o,r){let t=h(e,r);if(t)console.log(`Structure ${e} already exists`);else{const n=u(r);n["content-type"]="application/json";const a=JSON.stringify({hasApp:o,name:e});let l=c.post(`${f}/directory/school`,a,n);l.status!==201&&(console.error(l.body),i.fail(`Could not create structure ${e}`)),t=h(e,r)}return t}function K(e,o,r){let t=h(e,r);if(t)console.log("School already exists");else{const n=new S.FormData;n.append("type","CSV"),n.append("structureName",e);let a,l,d;"teachers"in o?(a=o.teachers,l=o.students,d=o.responsables):a=o,n.append("Teacher",c.file(a,"enseignants.csv")),l&&n.append("Student",c.file(l,"eleves.csv")),d&&n.append("Relative",c.file(d,"responsables.csv"));const g=u(r);g["Content-Type"]="multipart/form-data; boundary="+n.boundary;const p={headers:g};c.post(`${f}/directory/wizard/import`,n.body(),p).status!=200&&i.fail(`Could not create structure ${e}`),t=h(e,r)}return t}function q(e,o,r){let t;if((o.parents||[]).map(a=>a.id).indexOf(e.id)>=0)console.log(`${o.name} is already a child of ${e.name}`),t=!1;else{const a=u(r);a["content-type"]="application/json",c.put(`${f}/directory/structure/${o.id}/parent/${e.id}`,"{}").status!==200&&i.fail(`Could not attach structure ${o.name} as a child of ${e.name}`),t=!0}return t}function z(e,o,r){const t=new S.FormData;t.append("type","CSV"),t.append("structureName",e.name),t.append("structureId",e.id),t.append("structureExternalId",e.externalId);let n,a,l;"teachers"in o?(n=o.teachers,a=o.students,l=o.responsables):n=o,t.append("Teacher",c.file(n,"enseignants.csv")),a&&t.append("Student",c.file(a,"eleves.csv")),l&&t.append("Relative",c.file(l,"responsables.csv"));const d=u(r);d["Content-Type"]="multipart/form-data; boundary="+t.boundary;const g={headers:d};return c.post(`${f}/directory/wizard/import`,t.body(),g)}function X(e){const o=u(e);return o["content-type"]="application/json",c.post(`${f}/directory/import`,"{}",{headers:o})}const w=__ENV.ROOT_URL;function R(e,o){let r=c.get(`${w}/appregistry/roles`,{headers:u(o)});return JSON.parse(r.body).filter(n=>n.name===e)[0]}function Y(e,o){const r=`${e} - All - Stress Test`;let t=R(r,o);if(t)console.log(`Role ${r} already existed`);else{let n=c.get(`${w}/appregistry/applications/actions?actionType=WORKFLOW`,{headers:u(o)});i.check(n,{"get workflow actions":p=>p.status==200});const l=JSON.parse(n.body).filter(p=>p.name===e)[0].actions.map(p=>p[0]),d=u(o);d["content-type"]="application/json";const g={role:r,actions:l};n=c.post(`${w}/appregistry/role`,JSON.stringify(g),{headers:d}),console.log(n),i.check(n,{"save role ok":p=>p.status==201}),t=R(r,o)}return t}function b(e,o){const r=u(o);r["Accept-Language"]="en";let t=c.get(`${w}/appregistry/groups/roles?structureId=${e}&translate=false`,{headers:r});return i.check(t,{"get structure roles should be ok":n=>n.status==200}),JSON.parse(t.body)}const Q=__ENV.ROOT_URL,Z=["org-entcore-workspace-controllers-WorkspaceController|getDocument","org-entcore-workspace-controllers-WorkspaceController|copyDocuments","org-entcore-workspace-controllers-WorkspaceController|getDocumentProperties","org-entcore-workspace-controllers-WorkspaceController|getRevision","org-entcore-workspace-controllers-WorkspaceController|copyFolder","org-entcore-workspace-controllers-WorkspaceController|getPreview","org-entcore-workspace-controllers-WorkspaceController|copyDocument","org-entcore-workspace-controllers-WorkspaceController|getDocumentBase64","org-entcore-workspace-controllers-WorkspaceController|listRevisions","org-entcore-workspace-controllers-WorkspaceController|commentFolder","org-entcore-workspace-controllers-WorkspaceController|commentDocument","org-entcore-workspace-controllers-WorkspaceController|shareJson","org-entcore-workspace-controllers-WorkspaceController|deleteFolder","org-entcore-workspace-controllers-WorkspaceController|restoreFolder","org-entcore-workspace-controllers-WorkspaceController|removeShare","org-entcore-workspace-controllers-WorkspaceController|moveFolder","org-entcore-workspace-controllers-WorkspaceController|moveTrash","org-entcore-workspace-controllers-WorkspaceController|restoreTrash","org-entcore-workspace-controllers-WorkspaceController|bulkDelete","org-entcore-workspace-controllers-WorkspaceController|shareResource","org-entcore-workspace-controllers-WorkspaceController|deleteRevision","org-entcore-workspace-controllers-WorkspaceController|shareJsonSubmit","org-entcore-workspace-controllers-WorkspaceController|moveDocument","org-entcore-workspace-controllers-WorkspaceController|renameFolder","org-entcore-workspace-controllers-WorkspaceController|moveTrashFolder","org-entcore-workspace-controllers-WorkspaceController|deleteComment","org-entcore-workspace-controllers-WorkspaceController|getParentInfos","org-entcore-workspace-controllers-WorkspaceController|deleteDocument","org-entcore-workspace-controllers-WorkspaceController|renameDocument","org-entcore-workspace-controllers-WorkspaceController|moveDocuments","org-entcore-workspace-controllers-WorkspaceController|updateDocument"],x=["org-entcore-workspace-controllers-WorkspaceController|getDocument","org-entcore-workspace-controllers-WorkspaceController|copyDocuments","org-entcore-workspace-controllers-WorkspaceController|getDocumentProperties","org-entcore-workspace-controllers-WorkspaceController|getRevision","org-entcore-workspace-controllers-WorkspaceController|copyFolder","org-entcore-workspace-controllers-WorkspaceController|getPreview","org-entcore-workspace-controllers-WorkspaceController|copyDocument","org-entcore-workspace-controllers-WorkspaceController|getDocumentBase64","org-entcore-workspace-controllers-WorkspaceController|listRevisions","org-entcore-workspace-controllers-WorkspaceController|commentFolder","org-entcore-workspace-controllers-WorkspaceController|commentDocument"];function ee(e,o){let r=u(o);const t=new S.FormData;t.append("file",c.file(e,"file.txt")),r["Content-Type"]="multipart/form-data; boundary="+t.boundary;let n=c.post(`${Q}/workspace/document`,t.body(),{headers:r});return i.check(n,{"upload doc ok":a=>a.status===201}),JSON.parse(n.body)}const oe=__ENV.ROOT_URL;function re(e,o,r){const t=u(r);t["content-type"]="application/json";const n=JSON.stringify(o);return c.put(`${oe}/workspace/share/resource/${e}`,n,{headers:t})}const te=__ENV.ROOT_URL;function ne(e,o,r){const t=c.post(`${te}/communication/v2/group/${e}/communique/${o}`,"{}",{headers:u(r)});return t.status!==200&&(console.error(`Error while adding communication between ${e} -> ${o}`),console.error(t),i.fail(`could not add communication between ${e} -> ${o}`)),t}const $=__ENV.ROOT_URL;function se(e,o,r){let t=v(e,o,r);if(t)console.log("Broadcast group already existed");else{console.log("Creating broadcast group");const n=u(r);n["content-type"]="application/json";let a=JSON.stringify({name:e,structureId:o.id,subType:"BroadcastGroup"}),l=c.post(`${$}/directory/group`,a,{headers:n});i.check(l,{"create broadcast group":p=>p.status===201});const d=JSON.parse(l.body).id;a=JSON.stringify({name:e,autolinkTargetAllStructs:!0,autolinkTargetStructs:[],autolinkUsersFromGroups:["Teacher"]}),l=c.put(`${$}/directory/group/${d}`,a,{headers:n}),i.check(l,{"set broadcast group for teachers":p=>p.status===200});const g=T(o,r).id;U(d,[g],r),t=v(e,o,r)}return t}function U(e,o,r){const t=u(r);t["content-type"]="application/json";for(let n of o){let a=c.post(`${$}/communication/v2/group/${n}/communique/${e}`,"{}",{headers:t});a.status!==200&&(console.error(a),i.fail(`Cannot open comm rule from ${n} to ${e}`))}}function T(e,o){return C("teachers",e,o)}function ce(e,o){return C("students",e,o)}function ae(e,o){return C("relatives",e,o)}function C(e,o,r){return b(o.id,r).filter(n=>{const a=n.name.toLowerCase();return a===`${o.name} group ${e}.`.toLowerCase()||a===`${e} from group ${o.name}.`.toLowerCase()})[0]}function v(e,o,r){const t=u(r);t["content-type"]="application/json";let n=c.get(`${$}/directory/group/admin/list?translate=false&structureId=${o.id}`,{headers:t});return JSON.parse(n.body).filter(a=>a.subType==="BroadcastGroup"&&a.name===e)[0]}function le(e,o,r=200){const t=r||200;e.status!=t&&(console.error(`ko - ${o}. Expecting ${t} but got ${e.status}`),console.error(e),i.fail(o+" ko"))}s.BASE_URL=W,s.Session=O,s.SessionMode=m,s.WS_MANAGER_SHARE=Z,s.WS_READER_SHARE=x,s.activateUser=_,s.activateUsers=H,s.addCommRuleToGroup=U,s.addCommunicationBetweenGroups=ne,s.assertOk=le,s.attachStructureAsChild=q,s.authenticateOAuth2=J,s.authenticateWeb=N,s.createAndSetRole=Y,s.createBroadcastGroup=se,s.createEmptyStructure=P,s.createStructure=K,s.getBroadcastGroup=v,s.getConnectedUserId=D,s.getHeaders=u,s.getMetricValue=G,s.getParentRole=ae,s.getProfileGroupOfStructure=C,s.getRandomUser=F,s.getRoleByName=R,s.getRolesOfStructure=b,s.getSchoolByName=h,s.getStudentRole=ce,s.getTeacherRole=T,s.getUsersOfSchool=V,s.importUsers=z,s.linkRoleToUsers=M,s.searchUser=I,s.shareFile=re,s.switchSession=B,s.triggerImport=X,s.uploadFile=ee,Object.defineProperty(s,Symbol.toStringTag,{value:"Module"})});
