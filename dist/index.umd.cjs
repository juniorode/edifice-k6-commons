(function(a,n){typeof exports=="object"&&typeof module<"u"?n(exports,require("k6/http"),require("k6"),require("https://jslib.k6.io/formdata/0.0.2/index.js")):typeof define=="function"&&define.amd?define(["exports","k6/http","k6","https://jslib.k6.io/formdata/0.0.2/index.js"],n):(a=typeof globalThis<"u"?globalThis:a||self,n(a["edifice-k6-commons"]={},a.http,a.k6,a.index_js))})(this,function(a,n,l,U){"use strict";var z=Object.defineProperty;var W=(a,n,l)=>n in a?z(a,n,{enumerable:!0,configurable:!0,writable:!0,value:l}):a[n]=l;var m=(a,n,l)=>(W(a,typeof n!="symbol"?n+"":n,l),l);const h={COOKIE:0,OAUTH2:1};class S{constructor(e,o,s,r){m(this,"expiresAt");m(this,"token");m(this,"mode");m(this,"cookies");this.token=e,this.mode=o,this.cookies=r,this.expiresAt=Date.now()+s*1e3-3e3}isExpired(){return this.expiresAt<=Date.now()}getCookie(e){return this.cookies?this.cookies.filter(o=>o.name===e).map(o=>o.value)[0]:null}}const T=__ENV.BASE_URL,_=30*60,y=__ENV.ROOT_URL,p=function(t){let e;return t?t.mode===h.COOKIE?e={"x-xsrf-token":t.getCookie("XSRF-TOKEN")||""}:t.mode===h.OAUTH2?e={Authorization:`Bearer ${t.token}`}:e={}:e={},e},I=function(t,e){const o=n.get(`${y}/conversation/visible?search=${t}`,{headers:p(e)});return l.check(o,{"should get an OK response":r=>r.status==200}),o.json("users")[0].id},w=function(t){const e=n.get(`${y}/auth/oauth2/userinfo`,{headers:p(t)});return l.check(e,{"should get an OK response":o=>o.status==200,"should get a valid userId":o=>!!o.json("userId")}),e.json("userId")},N=function(t,e){let o={email:t,password:e,callBack:"",detail:""};const s=n.post(`${y}/auth/login`,o,{redirects:0});l.check(s,{"should redirect connected user to login page":c=>c.status===302,"should have set an auth cookie":c=>c.cookies.oneSessionId!==null&&c.cookies.oneSessionId!==void 0}),n.cookieJar().set(y,"oneSessionId",s.cookies.oneSessionId[0].value);const i=Object.keys(s.cookies).map(c=>({name:c,value:s.cookies[c][0].value}));return new S(s.cookies.oneSessionId[0].value,h.COOKIE,_,i)},j=function(t,e,o,s){let r={grant_type:"password",username:t,password:e,client_id:o,client_secret:s,scope:"timeline userbook blog lvs actualites pronote schoolbook support viescolaire zimbra conversation directory homeworks userinfo workspace portal cas sso presences incidents competences diary edt infra auth"},i=n.post(`${y}/auth/oauth2/token`,r,{redirects:0});l.check(i,{"should get an OK response for authentication":u=>u.status==200,"should have set an access token":u=>!!u.json("access_token")});const c=i.json("access_token");return new S(c,h.OAUTH2,i.json("expires_in"))};function A(t,e){const o=(e||[]).map(s=>s.id);for(let s=0;s<1e3;s++){const r=t[Math.floor(Math.random()*t.length)];if(o.indexOf(r.id)<0)return r}throw"cannot.find.random.user"}const C=function(t,e){const o=n.get(`${T}/metrics`,{headers:p(e)});l.check(o,{"should get an OK response":r=>r.status==200});const s=o.body.split(`
`);for(let r of s)if(r.indexOf(`${t} `)===0)return parseFloat(r.substring(t.length+1).trim());return console.error("Metric",t,"not found"),null},f=__ENV.ROOT_URL;function k(t,e){let o=n.get(`${f}/directory/api/ecole`,{headers:p(e)});const s=JSON.parse(o.body).result;return Object.keys(s||{}).map(i=>s[i]).filter(i=>i.name===t)[0]}function E(t,e){let o=n.get(`${f}/directory/structure/${t.id}/users`,{headers:p(e)});if(o.status!==200)throw`Impossible to get users of ${t.id}`;return JSON.parse(o.body)}function J(t,e){let o=n.get(`${f}/directory/structure/${t.id}/users`,{headers:p(e)});o.status!=200&&l.fail(`Cannot fetch users of structure ${t.id} : ${o}`);const s=JSON.parse(o.body);for(let r=0;r<s.length;r++){const i=s[r];v(i)}}function v(t){if(t.code){const e={};e.login=t.login,e.activationCode=t.code,e.password="password",e.confirmPassword="password",e.acceptCGU="true";const o=n.post(`${f}/auth/activation`,e,{redirects:0,headers:{Host:"localhost"}});o.status!==302&&l.fail(`Could not activate user ${t.login} : ${o}`)}}function B(t,e,o,s){const i=R(t.id,s).filter(c=>o.indexOf(c.name)>=0);for(let c of i)if(c.roles.indexOf(e.name)>=0)console.log("Role already attributed to teachers");else{const u=p(s);u["content-type"]="application/json";const g={headers:u},d=JSON.stringify({groupId:c.id,roleIds:(c.roles||[]).concat([e.id])}),$=n.post(`${f}/appregistry/authorize/group?schoolId=${t.id}`,d,g);l.check($,{"link role to structure":q=>q.status==200})}}function F(t,e,o){let s=k(t,o);if(s)console.log("School already exists");else{const r=new U.FormData;r.append("type","CSV"),r.append("structureName",t);let i,c,u;"teachers"in e?(i=e.teachers,c=e.students,u=e.responsables):i=e,r.append("Teacher",n.file(i,"enseignants.csv")),c&&r.append("Student",n.file(c,"eleves.csv")),u&&r.append("Relative",n.file(u,"responsables.csv"));const g=p(o);g["Content-Type"]="multipart/form-data; boundary="+r.boundary;const d={headers:g},$=n.post(`${f}/directory/wizard/import`,r.body(),d);$.status!=200&&l.fail(`Could not create structure ${t} : ${$}`),s=k(t,o)}return s}function K(t,e,o){const s=p(o);s["content-type"]="application/json";let r=n.get(`${f}/directory/group/admin/list?translate=false&structureId=${e.id}`,{headers:s}),i=JSON.parse(r.body).filter(c=>c.subType==="BroadcastGroup"&&c.name===t)[0];if(i)console.log("Broadcast group already existed");else{console.log("Creating broadcast group");let c=JSON.stringify({name:t,structureId:e.id,subType:"BroadcastGroup"});r=n.post(`${f}/directory/group`,c,{headers:s}),l.check(r,{"create broadcast group":d=>d.status===201});const u=JSON.parse(r.body).id;c=JSON.stringify({name:t,autolinkTargetAllStructs:!0,autolinkTargetStructs:[],autolinkUsersFromGroups:["Teacher"]}),r=n.put(`${f}/directory/group/${u}`,c,{headers:s}),l.check(r,{"set broadcast group for teachers":d=>d.status===200});const g=M(e,o).id;r=n.post(`${f}/communication/v2/group/${g}/communique/${u}`,"{}",{headers:s}),l.check(r,{"open comm rule for broadcast group for teachers":d=>d.status===200}),r=n.get(`${f}/communication/group/${u}`,{headers:s}),i=JSON.parse(r.body)}return i}function M(t,e){return R(t.id,e).filter(s=>s.name===`Teachers from group ${t.name}.`||s.name===`Enseignants du groupe ${t.name}.`)[0]}const O=__ENV.ROOT_URL;function b(t,e){let o=n.get(`${O}/appregistry/roles`,{headers:p(e)});return JSON.parse(o.body).filter(r=>r.name===t)[0]}function V(t,e){const o=`${t} - All - Stress Test`;let s=b(o,e);if(s)console.log(`Role ${o} already existed`);else{let r=n.get(`${O}/appregistry/applications/actions?actionType=WORKFLOW`,{headers:p(e)});l.check(r,{"get workflow actions":d=>d.status==200});const c=JSON.parse(r.body).filter(d=>d.name===t)[0].actions.map(d=>d[0]),u=p(e);u["content-type"]="application/json";const g={role:o,actions:c};r=n.post(`${O}/appregistry/role`,JSON.stringify(g),{headers:u}),console.log(r),l.check(r,{"save role ok":d=>d.status==201}),s=b(o,e)}return s}function R(t,e){let o=n.get(`${O}/appregistry/groups/roles?structureId=${t}`,{headers:p(e)});return l.check(o,{"get structure roles should be ok":s=>s.status==200}),JSON.parse(o.body)}const G=__ENV.ROOT_URL;function H(t,e){let o=p(e);const s=new U.FormData;s.append("file",n.file(t,"file.txt")),o["Content-Type"]="multipart/form-data; boundary="+s.boundary;let r=n.post(`${G}/workspace/document`,s.body(),{headers:o});return l.check(r,{"upload doc ok":i=>i.status===201}),JSON.parse(r.body)}const L=__ENV.ROOT_URL;function D(t,e,o){const s=p(o);s["content-type"]="application/json";const r=JSON.stringify(e);return n.put(`${L}/workspace/share/resource/${t}`,r,{headers:s})}a.BASE_URL=T,a.Session=S,a.SessionMode=h,a.activateUser=v,a.activateUsers=J,a.authenticateOAuth2=j,a.authenticateWeb=N,a.createAndSetRole=V,a.createBroadcastGroup=K,a.createStructure=F,a.getConnectedUserId=w,a.getHeaders=p,a.getMetricValue=C,a.getRandomUser=A,a.getRoleByName=b,a.getRolesOfStructure=R,a.getSchoolByName=k,a.getUsersOfSchool=E,a.linkRoleToUsers=B,a.searchUser=I,a.shareFile=D,a.uploadFile=H,Object.defineProperty(a,Symbol.toStringTag,{value:"Module"})});
