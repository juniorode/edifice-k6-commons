(function(r,c){typeof exports=="object"&&typeof module<"u"?c(exports,require("k6/http"),require("k6"),require("https://jslib.k6.io/formdata/0.0.2/index.js")):typeof define=="function"&&define.amd?define(["exports","k6/http","k6","https://jslib.k6.io/formdata/0.0.2/index.js"],c):(r=typeof globalThis<"u"?globalThis:r||self,c(r["edifice-k6-commons"]={},r.http,r.k6,r.index_js))})(this,function(r,c,u,_){"use strict";var J=Object.defineProperty;var K=(r,c,u)=>c in r?J(r,c,{enumerable:!0,configurable:!0,writable:!0,value:u}):r[c]=u;var y=(r,c,u)=>(K(r,typeof c!="symbol"?c+"":c,u),u);const f={COOKIE:0,OAUTH2:1};class m{constructor(s,e,n,o){y(this,"expiresAt");y(this,"token");y(this,"mode");y(this,"cookies");this.token=s,this.mode=e,this.cookies=o,this.expiresAt=Date.now()+n*1e3-3e3}isExpired(){return this.expiresAt<=Date.now()}getCookie(s){return this.cookies?this.cookies.filter(e=>e.name===s).map(e=>e.value)[0]:null}}const b=__ENV.BASE_URL,R=30*60,g=__ENV.ROOT_URL,l=function(t){let s;return t?t.mode===f.COOKIE?s={"x-xsrf-token":t.getCookie("XSRF-TOKEN")||""}:t.mode===f.OAUTH2?s={Authorization:`Bearer ${t.token}`}:s={}:s={},s},v=function(t,s){const e=c.get(`${g}/conversation/visible?search=${t}`,{headers:l(s)});return u.check(e,{"should get an OK response":o=>o.status==200}),e.json("users")[0].id},I=function(t){const s=c.get(`${g}/auth/oauth2/userinfo`,{headers:l(t)});return u.check(s,{"should get an OK response":e=>e.status==200,"should get a valid userId":e=>!!e.json("userId")}),s.json("userId")},T=function(t,s){let e={email:t,password:s,callBack:"",detail:""};const n=c.post(`${g}/auth/login`,e,{redirects:0});u.check(n,{"should redirect connected user to login page":i=>i.status===302,"should have set an auth cookie":i=>i.cookies.oneSessionId!==null&&i.cookies.oneSessionId!==void 0}),c.cookieJar().set(g,"oneSessionId",n.cookies.oneSessionId[0].value);const a=Object.keys(n.cookies).map(i=>({name:i,value:n.cookies[i][0].value}));return new m(n.cookies.oneSessionId[0].value,f.COOKIE,R,a)},j=function(t,s,e,n){let o={grant_type:"password",username:t,password:s,client_id:e,client_secret:n,scope:"timeline userbook blog lvs actualites pronote schoolbook support viescolaire zimbra conversation directory homeworks userinfo workspace portal cas sso presences incidents competences diary edt infra auth"},a=c.post(`${g}/auth/oauth2/token`,o,{redirects:0});u.check(a,{"should get an OK response for authentication":d=>d.status==200,"should have set an access token":d=>!!d.json("access_token")});const i=a.json("access_token");return new m(i,f.OAUTH2,a.json("expires_in"))},w=function(t,s){const e=c.get(`${b}/metrics`,{headers:l(s)});u.check(e,{"should get an OK response":o=>o.status==200});const n=e.body.split(`
`);for(let o of n)if(o.indexOf(`${t} `)===0)return parseFloat(o.substring(t.length+1).trim());return console.error("Metric",t,"not found"),null},h=__ENV.ROOT_URL;function S(t,s){let e=c.get(`${h}/directory/api/ecole`,{headers:l(s)});const n=JSON.parse(e.body).result;return Object.keys(n||{}).map(a=>n[a]).filter(a=>a.name===t)[0]}function A(t,s){let e=c.get(`${h}/directory/structure/${t.id}/users`,{headers:l(s)});if(e.status!==200)throw`Impossible to get users of ${t.id}`;return JSON.parse(e.body)}function N(t,s){let e=c.get(`${h}/directory/structure/${t.id}/users`,{headers:l(s)});u.check(e,{"fetch structure users":o=>o.status==200});const n=JSON.parse(e.body);for(let o=0;o<n.length;o++){const a=n[o];if(a.code){const i={};i.login=a.login,i.activationCode=a.code,i.password="password",i.confirmPassword="password",i.acceptCGU="true",e=c.post(`${h}/auth/activation`,i,{redirects:0,headers:{Host:"localhost"}}),u.check(e,{"activate user":d=>d.status===302})}}}function E(t,s,e){const o=U(t.id,e).filter(a=>a.name===`Teachers from group ${t.name}.`||a.name===`Enseignants du groupe ${t.name}.`)[0];if(o.roles.indexOf(s.name)>=0)console.log("Role already attributed to teachers");else{const a=l(e);a["content-type"]="application/json";const i={headers:a},d=JSON.stringify({groupId:o.id,roleIds:(o.roles||[]).concat([s.id])}),k=c.post(`${h}/appregistry/authorize/group?schoolId=${t.id}`,d,i);u.check(k,{"link role to structure":p=>p.status==200})}}function C(t,s,e){let n=S(t,e);if(n)console.log("School already exists");else{const o=new _.FormData;o.append("type","CSV"),o.append("structureName",t),o.append("Teacher",c.file(s,"enseignants.csv"));const a=l(e);a["Content-Type"]="multipart/form-data; boundary="+o.boundary;const i={headers:a},d=c.post(`${h}/directory/wizard/import`,o.body(),i);u.check(d,{"import structure is ok":k=>k.status==200}),n=S(t,e)}return n}const O=__ENV.ROOT_URL;function $(t,s){let e=c.get(`${O}/appregistry/roles`,{headers:l(s)});return JSON.parse(e.body).filter(o=>o.name===t)[0]}function B(t,s){const e=`${t} - All - Stress Test`;let n=$(e,s);if(n)console.log(`Role ${e} already existed`);else{let o=c.get(`${O}/appregistry/applications/actions?actionType=WORKFLOW`,{headers:l(s)});u.check(o,{"get workflow actions":p=>p.status==200});const i=JSON.parse(o.body).filter(p=>p.name===t)[0].actions.map(p=>p[0]),d=l(s);d["content-type"]="application/json";const k={role:e,actions:i};o=c.post(`${O}/appregistry/role`,JSON.stringify(k),{headers:d}),console.log(o),u.check(o,{"save role ok":p=>p.status==201}),n=$(e,s)}return n}function U(t,s){let e=c.get(`${O}/appregistry/groups/roles?structureId=${t}`,{headers:l(s)});return u.check(e,{"get structure roles should be ok":n=>n.status==200}),JSON.parse(e.body)}r.BASE_URL=b,r.Session=m,r.SessionMode=f,r.activateUsers=N,r.authenticateOAuth2=j,r.authenticateWeb=T,r.createAndSetRole=B,r.createStructure=C,r.getConnectedUserId=I,r.getHeaders=l,r.getMetricValue=w,r.getRoleByName=$,r.getRolesOfStructure=U,r.getSchoolByName=S,r.getUsersOfSchool=A,r.linkRoleToUsers=E,r.searchUser=v,Object.defineProperty(r,Symbol.toStringTag,{value:"Module"})});
