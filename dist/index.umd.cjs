(function(c,n){typeof exports=="object"&&typeof module<"u"?n(exports,require("k6/http"),require("k6"),require("https://jslib.k6.io/formdata/0.0.2/index.js")):typeof define=="function"&&define.amd?define(["exports","k6/http","k6","https://jslib.k6.io/formdata/0.0.2/index.js"],n):(c=typeof globalThis<"u"?globalThis:c||self,n(c["edifice-k6-commons"]={},c.http,c.k6,c.index_js))})(this,function(c,n,u,U){"use strict";var D=Object.defineProperty;var q=(c,n,u)=>n in c?D(c,n,{enumerable:!0,configurable:!0,writable:!0,value:u}):c[n]=u;var m=(c,n,u)=>(q(c,typeof n!="symbol"?n+"":n,u),u);const h={COOKIE:0,OAUTH2:1};class k{constructor(e,t,r,s){m(this,"expiresAt");m(this,"token");m(this,"mode");m(this,"cookies");this.token=e,this.mode=t,this.cookies=s,this.expiresAt=Date.now()+r*1e3-3e3}isExpired(){return this.expiresAt<=Date.now()}getCookie(e){return this.cookies?this.cookies.filter(t=>t.name===e).map(t=>t.value)[0]:null}}const _=__ENV.BASE_URL,v=30*60,y=__ENV.ROOT_URL,p=function(o){let e;return o?o.mode===h.COOKIE?e={"x-xsrf-token":o.getCookie("XSRF-TOKEN")||""}:o.mode===h.OAUTH2?e={Authorization:`Bearer ${o.token}`}:e={}:e={},e},I=function(o,e){const t=n.get(`${y}/conversation/visible?search=${o}`,{headers:p(e)});return u.check(t,{"should get an OK response":s=>s.status==200}),t.json("users")[0].id},N=function(o){const e=n.get(`${y}/auth/oauth2/userinfo`,{headers:p(o)});return u.check(e,{"should get an OK response":t=>t.status==200,"should get a valid userId":t=>!!t.json("userId")}),e.json("userId")},w=function(o,e){let t={email:o,password:e,callBack:"",detail:""};const r=n.post(`${y}/auth/login`,t,{redirects:0});u.check(r,{"should redirect connected user to login page":a=>a.status===302,"should have set an auth cookie":a=>a.cookies.oneSessionId!==null&&a.cookies.oneSessionId!==void 0}),n.cookieJar().set(y,"oneSessionId",r.cookies.oneSessionId[0].value);const i=Object.keys(r.cookies).map(a=>({name:a,value:r.cookies[a][0].value}));return new k(r.cookies.oneSessionId[0].value,h.COOKIE,v,i)},j=function(o,e,t,r){let s={grant_type:"password",username:o,password:e,client_id:t,client_secret:r,scope:"timeline userbook blog lvs actualites pronote schoolbook support viescolaire zimbra conversation directory homeworks userinfo workspace portal cas sso presences incidents competences diary edt infra auth"},i=n.post(`${y}/auth/oauth2/token`,s,{redirects:0});u.check(i,{"should get an OK response for authentication":l=>l.status==200,"should have set an access token":l=>!!l.json("access_token")});const a=i.json("access_token");return new k(a,h.OAUTH2,i.json("expires_in"))},A=function(o,e){const t=n.get(`${_}/metrics`,{headers:p(e)});u.check(t,{"should get an OK response":s=>s.status==200});const r=t.body.split(`
`);for(let s of r)if(s.indexOf(`${o} `)===0)return parseFloat(s.substring(o.length+1).trim());return console.error("Metric",o,"not found"),null},f=__ENV.ROOT_URL;function S(o,e){let t=n.get(`${f}/directory/api/ecole`,{headers:p(e)});const r=JSON.parse(t.body).result;return Object.keys(r||{}).map(i=>r[i]).filter(i=>i.name===o)[0]}function E(o,e){let t=n.get(`${f}/directory/structure/${o.id}/users`,{headers:p(e)});if(t.status!==200)throw`Impossible to get users of ${o.id}`;return JSON.parse(t.body)}function J(o,e){let t=n.get(`${f}/directory/structure/${o.id}/users`,{headers:p(e)});u.check(t,{"fetch structure users":s=>s.status==200});const r=JSON.parse(t.body);for(let s=0;s<r.length;s++){const i=r[s];if(i.code){const a={};a.login=i.login,a.activationCode=i.code,a.password="password",a.confirmPassword="password",a.acceptCGU="true",t=n.post(`${f}/auth/activation`,a,{redirects:0,headers:{Host:"localhost"}}),u.check(t,{"activate user":l=>l.status===302})}}}function B(o,e,t,r){const i=b(o.id,r).filter(a=>t.indexOf(a.name)>=0);for(let a of i)if(a.roles.indexOf(e.name)>=0)console.log("Role already attributed to teachers");else{const l=p(r);l["content-type"]="application/json";const g={headers:l},d=JSON.stringify({groupId:a.id,roleIds:(a.roles||[]).concat([e.id])}),R=n.post(`${f}/appregistry/authorize/group?schoolId=${o.id}`,d,g);u.check(R,{"link role to structure":T=>T.status==200})}}function C(o,e,t){let r=S(o,t);if(r)console.log("School already exists");else{const s=new U.FormData;s.append("type","CSV"),s.append("structureName",o);let i,a,l;"teachers"in e?(i=e.teachers,a=e.students,l=e.responsables):i=e,s.append("Teacher",n.file(i,"enseignants.csv")),a&&s.append("Student",n.file(a,"eleves.csv")),l&&s.append("Relative",n.file(l,"responsables.csv"));const g=p(t);g["Content-Type"]="multipart/form-data; boundary="+s.boundary;const d={headers:g},R=n.post(`${f}/directory/wizard/import`,s.body(),d);u.check(R,{"import structure is ok":T=>T.status==200}),r=S(o,t)}return r}function F(o,e,t){const r=p(t);r["content-type"]="application/json";let s=n.get(`${f}/directory/group/admin/list?translate=false&structureId=${e.id}`,{headers:r}),i=JSON.parse(s.body).filter(a=>a.subType==="BroadcastGroup"&&a.name===o)[0];if(i)console.log("Broadcast group already existed");else{console.log("Creating broadcast group");let a=JSON.stringify({name:o,structureId:e.id,subType:"BroadcastGroup"});s=n.post(`${f}/directory/group`,a,{headers:r}),u.check(s,{"create broadcast group":d=>d.status===201});const l=JSON.parse(s.body).id;a=JSON.stringify({name:o,autolinkTargetAllStructs:!0,autolinkTargetStructs:[],autolinkUsersFromGroups:["Teacher"]}),s=n.put(`${f}/directory/group/${l}`,a,{headers:r}),u.check(s,{"set broadcast group for teachers":d=>d.status===200});const g=K(e,t).id;s=n.post(`${f}/communication/v2/group/${g}/communique/${l}`,"{}",{headers:r}),u.check(s,{"open comm rule for broadcast group for teachers":d=>d.status===200}),s=n.get(`${f}/communication/group/${l}`,{headers:r}),i=JSON.parse(s.body)}return i}function K(o,e){return b(o.id,e).filter(r=>r.name===`Teachers from group ${o.name}.`||r.name===`Enseignants du groupe ${o.name}.`)[0]}const O=__ENV.ROOT_URL;function $(o,e){let t=n.get(`${O}/appregistry/roles`,{headers:p(e)});return JSON.parse(t.body).filter(s=>s.name===o)[0]}function V(o,e){const t=`${o} - All - Stress Test`;let r=$(t,e);if(r)console.log(`Role ${t} already existed`);else{let s=n.get(`${O}/appregistry/applications/actions?actionType=WORKFLOW`,{headers:p(e)});u.check(s,{"get workflow actions":d=>d.status==200});const a=JSON.parse(s.body).filter(d=>d.name===o)[0].actions.map(d=>d[0]),l=p(e);l["content-type"]="application/json";const g={role:t,actions:a};s=n.post(`${O}/appregistry/role`,JSON.stringify(g),{headers:l}),console.log(s),u.check(s,{"save role ok":d=>d.status==201}),r=$(t,e)}return r}function b(o,e){let t=n.get(`${O}/appregistry/groups/roles?structureId=${o}`,{headers:p(e)});return u.check(t,{"get structure roles should be ok":r=>r.status==200}),JSON.parse(t.body)}const G=__ENV.ROOT_URL;function H(o,e){let t=p(e);const r=new U.FormData;r.append("file",n.file(o,"file.txt")),t["Content-Type"]="multipart/form-data; boundary="+r.boundary;let s=n.post(`${G}/workspace/document`,r.body(),{headers:t});return u.check(s,{"upload doc ok":i=>i.status===201}),JSON.parse(s.body)}const L=__ENV.ROOT_URL;function M(o,e,t){const r=p(t);r["content-type"]="application/json";const s=JSON.stringify(e);return n.put(`${L}/workspace/share/resource/${o}`,s,{headers:r})}c.BASE_URL=_,c.Session=k,c.SessionMode=h,c.activateUsers=J,c.authenticateOAuth2=j,c.authenticateWeb=w,c.createAndSetRole=V,c.createBroadcastGroup=F,c.createStructure=C,c.getConnectedUserId=N,c.getHeaders=p,c.getMetricValue=A,c.getRoleByName=$,c.getRolesOfStructure=b,c.getSchoolByName=S,c.getUsersOfSchool=E,c.linkRoleToUsers=B,c.searchUser=I,c.shareFile=M,c.uploadFile=H,Object.defineProperty(c,Symbol.toStringTag,{value:"Module"})});
