(function(n,c){typeof exports=="object"&&typeof module<"u"?c(exports,require("k6/http"),require("k6"),require("https://jslib.k6.io/formdata/0.0.2/index.js")):typeof define=="function"&&define.amd?define(["exports","k6/http","k6","https://jslib.k6.io/formdata/0.0.2/index.js"],c):(n=typeof globalThis<"u"?globalThis:n||self,c(n["edifice-k6-commons"]={},n.http,n.k6,n.index_js))})(this,function(n,c,l,_){"use strict";var H=Object.defineProperty;var L=(n,c,l)=>c in n?H(n,c,{enumerable:!0,configurable:!0,writable:!0,value:l}):n[c]=l;var y=(n,c,l)=>(L(n,typeof c!="symbol"?c+"":c,l),l);const g={COOKIE:0,OAUTH2:1};class S{constructor(t,e,r,o){y(this,"expiresAt");y(this,"token");y(this,"mode");y(this,"cookies");this.token=t,this.mode=e,this.cookies=o,this.expiresAt=Date.now()+r*1e3-3e3}isExpired(){return this.expiresAt<=Date.now()}getCookie(t){return this.cookies?this.cookies.filter(e=>e.name===t).map(e=>e.value)[0]:null}}const R=__ENV.BASE_URL,I=30*60,k=__ENV.ROOT_URL,d=function(s){let t;return s?s.mode===g.COOKIE?t={"x-xsrf-token":s.getCookie("XSRF-TOKEN")||""}:s.mode===g.OAUTH2?t={Authorization:`Bearer ${s.token}`}:t={}:t={},t},T=function(s,t){const e=c.get(`${k}/conversation/visible?search=${s}`,{headers:d(t)});return l.check(e,{"should get an OK response":o=>o.status==200}),e.json("users")[0].id},j=function(s){const t=c.get(`${k}/auth/oauth2/userinfo`,{headers:d(s)});return l.check(t,{"should get an OK response":e=>e.status==200,"should get a valid userId":e=>!!e.json("userId")}),t.json("userId")},w=function(s,t){let e={email:s,password:t,callBack:"",detail:""};const r=c.post(`${k}/auth/login`,e,{redirects:0});l.check(r,{"should redirect connected user to login page":a=>a.status===302,"should have set an auth cookie":a=>a.cookies.oneSessionId!==null&&a.cookies.oneSessionId!==void 0}),c.cookieJar().set(k,"oneSessionId",r.cookies.oneSessionId[0].value);const i=Object.keys(r.cookies).map(a=>({name:a,value:r.cookies[a][0].value}));return new S(r.cookies.oneSessionId[0].value,g.COOKIE,I,i)},A=function(s,t,e,r){let o={grant_type:"password",username:s,password:t,client_id:e,client_secret:r,scope:"timeline userbook blog lvs actualites pronote schoolbook support viescolaire zimbra conversation directory homeworks userinfo workspace portal cas sso presences incidents competences diary edt infra auth"},i=c.post(`${k}/auth/oauth2/token`,o,{redirects:0});l.check(i,{"should get an OK response for authentication":u=>u.status==200,"should have set an access token":u=>!!u.json("access_token")});const a=i.json("access_token");return new S(a,g.OAUTH2,i.json("expires_in"))},N=function(s,t){const e=c.get(`${R}/metrics`,{headers:d(t)});l.check(e,{"should get an OK response":o=>o.status==200});const r=e.body.split(`
`);for(let o of r)if(o.indexOf(`${s} `)===0)return parseFloat(o.substring(s.length+1).trim());return console.error("Metric",s,"not found"),null},p=__ENV.ROOT_URL;function m(s,t){let e=c.get(`${p}/directory/api/ecole`,{headers:d(t)});const r=JSON.parse(e.body).result;return Object.keys(r||{}).map(i=>r[i]).filter(i=>i.name===s)[0]}function E(s,t){let e=c.get(`${p}/directory/structure/${s.id}/users`,{headers:d(t)});if(e.status!==200)throw`Impossible to get users of ${s.id}`;return JSON.parse(e.body)}function C(s,t){let e=c.get(`${p}/directory/structure/${s.id}/users`,{headers:d(t)});l.check(e,{"fetch structure users":o=>o.status==200});const r=JSON.parse(e.body);for(let o=0;o<r.length;o++){const i=r[o];if(i.code){const a={};a.login=i.login,a.activationCode=i.code,a.password="password",a.confirmPassword="password",a.acceptCGU="true",e=c.post(`${p}/auth/activation`,a,{redirects:0,headers:{Host:"localhost"}}),l.check(e,{"activate user":u=>u.status===302})}}}function B(s,t,e,r){const i=U(s.id,r).filter(a=>e.indexOf(a.name)>=0);for(let a of i)if(a.roles.indexOf(t.name)>=0)console.log("Role already attributed to teachers");else{const u=d(r);u["content-type"]="application/json";const h={headers:u},f=JSON.stringify({groupId:a.id,roleIds:(a.roles||[]).concat([t.id])}),$=c.post(`${p}/appregistry/authorize/group?schoolId=${s.id}`,f,h);l.check($,{"link role to structure":v=>v.status==200})}}function J(s,t,e){let r=m(s,e);if(r)console.log("School already exists");else{const o=new _.FormData;o.append("type","CSV"),o.append("structureName",s);let i,a,u;"teachers"in t?(i=t.teachers,a=t.students,u=t.responsables):i=t,o.append("Teacher",c.file(i,"enseignants.csv")),a&&o.append("Student",c.file(a,"eleves.csv")),u&&o.append("Relative",c.file(u,"responsables.csv"));const h=d(e);h["Content-Type"]="multipart/form-data; boundary="+o.boundary;const f={headers:h},$=c.post(`${p}/directory/wizard/import`,o.body(),f);l.check($,{"import structure is ok":v=>v.status==200}),r=m(s,e)}return r}const O=__ENV.ROOT_URL;function b(s,t){let e=c.get(`${O}/appregistry/roles`,{headers:d(t)});return JSON.parse(e.body).filter(o=>o.name===s)[0]}function K(s,t){const e=`${s} - All - Stress Test`;let r=b(e,t);if(r)console.log(`Role ${e} already existed`);else{let o=c.get(`${O}/appregistry/applications/actions?actionType=WORKFLOW`,{headers:d(t)});l.check(o,{"get workflow actions":f=>f.status==200});const a=JSON.parse(o.body).filter(f=>f.name===s)[0].actions.map(f=>f[0]),u=d(t);u["content-type"]="application/json";const h={role:e,actions:a};o=c.post(`${O}/appregistry/role`,JSON.stringify(h),{headers:u}),console.log(o),l.check(o,{"save role ok":f=>f.status==201}),r=b(e,t)}return r}function U(s,t){let e=c.get(`${O}/appregistry/groups/roles?structureId=${s}`,{headers:d(t)});return l.check(e,{"get structure roles should be ok":r=>r.status==200}),JSON.parse(e.body)}n.BASE_URL=R,n.Session=S,n.SessionMode=g,n.activateUsers=C,n.authenticateOAuth2=A,n.authenticateWeb=w,n.createAndSetRole=K,n.createStructure=J,n.getConnectedUserId=j,n.getHeaders=d,n.getMetricValue=N,n.getRoleByName=b,n.getRolesOfStructure=U,n.getSchoolByName=m,n.getUsersOfSchool=E,n.linkRoleToUsers=B,n.searchUser=T,Object.defineProperty(n,Symbol.toStringTag,{value:"Module"})});
