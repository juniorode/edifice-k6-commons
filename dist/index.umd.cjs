(function(n,r){typeof exports=="object"&&typeof module<"u"?r(exports,require("k6/http"),require("k6"),require("https://jslib.k6.io/formdata/0.0.2/index.js")):typeof define=="function"&&define.amd?define(["exports","k6/http","k6","https://jslib.k6.io/formdata/0.0.2/index.js"],r):(n=typeof globalThis<"u"?globalThis:n||self,r(n["edifice-k6-commons"]={},n.http,n.k6,n.index_js))})(this,function(n,r,l,R){"use strict";var H=Object.defineProperty;var L=(n,r,l)=>r in n?H(n,r,{enumerable:!0,configurable:!0,writable:!0,value:l}):n[r]=l;var y=(n,r,l)=>(L(n,typeof r!="symbol"?r+"":r,l),l);const g={COOKIE:0,OAUTH2:1};class m{constructor(t,e,c,o){y(this,"expiresAt");y(this,"token");y(this,"mode");y(this,"cookies");this.token=t,this.mode=e,this.cookies=o,this.expiresAt=Date.now()+c*1e3-3e3}isExpired(){return this.expiresAt<=Date.now()}getCookie(t){return this.cookies?this.cookies.filter(e=>e.name===t).map(e=>e.value)[0]:null}}const b=__ENV.BASE_URL,U=30*60,k=__ENV.ROOT_URL,d=function(s){let t;return s?s.mode===g.COOKIE?t={"x-xsrf-token":s.getCookie("XSRF-TOKEN")||""}:s.mode===g.OAUTH2?t={Authorization:`Bearer ${s.token}`}:t={}:t={},t},_=function(s,t){const e=r.get(`${k}/conversation/visible?search=${s}`,{headers:d(t)});return l.check(e,{"should get an OK response":o=>o.status==200}),e.json("users")[0].id},I=function(s){const t=r.get(`${k}/auth/oauth2/userinfo`,{headers:d(s)});return l.check(t,{"should get an OK response":e=>e.status==200,"should get a valid userId":e=>!!e.json("userId")}),t.json("userId")},T=function(s,t){let e={email:s,password:t,callBack:"",detail:""};const c=r.post(`${k}/auth/login`,e,{redirects:0});l.check(c,{"should redirect connected user to login page":i=>i.status===302,"should have set an auth cookie":i=>i.cookies.oneSessionId!==null&&i.cookies.oneSessionId!==void 0}),r.cookieJar().set(k,"oneSessionId",c.cookies.oneSessionId[0].value);const a=Object.keys(c.cookies).map(i=>({name:i,value:c.cookies[i][0].value}));return new m(c.cookies.oneSessionId[0].value,g.COOKIE,U,a)},j=function(s,t,e,c){let o={grant_type:"password",username:s,password:t,client_id:e,client_secret:c,scope:"timeline userbook blog lvs actualites pronote schoolbook support viescolaire zimbra conversation directory homeworks userinfo workspace portal cas sso presences incidents competences diary edt infra auth"},a=r.post(`${k}/auth/oauth2/token`,o,{redirects:0});l.check(a,{"should get an OK response for authentication":u=>u.status==200,"should have set an access token":u=>!!u.json("access_token")});const i=a.json("access_token");return new m(i,g.OAUTH2,a.json("expires_in"))},w=function(s,t){const e=r.get(`${b}/metrics`,{headers:d(t)});l.check(e,{"should get an OK response":o=>o.status==200});const c=e.body.split(`
`);for(let o of c)if(o.indexOf(`${s} `)===0)return parseFloat(o.substring(s.length+1).trim());return console.error("Metric",s,"not found"),null},f=__ENV.ROOT_URL;function S(s,t){let e=r.get(`${f}/directory/api/ecole`,{headers:d(t)});const c=JSON.parse(e.body).result;return Object.keys(c||{}).map(a=>c[a]).filter(a=>a.name===s)[0]}function A(s,t){let e=r.get(`${f}/directory/structure/${s.id}/users`,{headers:d(t)});if(e.status!==200)throw`Impossible to get users of ${s.id}`;return JSON.parse(e.body)}function N(s,t){let e=r.get(`${f}/directory/structure/${s.id}/users`,{headers:d(t)});l.check(e,{"fetch structure users":o=>o.status==200});const c=JSON.parse(e.body);for(let o=0;o<c.length;o++){const a=c[o];if(a.code){const i={};i.login=a.login,i.activationCode=a.code,i.password="password",i.confirmPassword="password",i.acceptCGU="true",e=r.post(`${f}/auth/activation`,i,{redirects:0,headers:{Host:"localhost"}}),l.check(e,{"activate user":u=>u.status===302})}}}function E(s,t,e){const o=v(s.id,e).filter(a=>a.name===`Teachers from group ${s.name}.`||a.name===`Enseignants du groupe ${s.name}.`)[0];if(o.roles.indexOf(t.name)>=0)console.log("Role already attributed to teachers");else{const a=d(e);a["content-type"]="application/json";const i={headers:a},u=JSON.stringify({groupId:o.id,roleIds:(o.roles||[]).concat([t.id])}),h=r.post(`${f}/appregistry/authorize/group?schoolId=${s.id}`,u,i);l.check(h,{"link role to structure":p=>p.status==200})}}function C(s,t,e){let c=S(s,e);if(c)console.log("School already exists");else{const o=new R.FormData;o.append("type","CSV"),o.append("structureName",s);let a,i,u;"teachers"in t?(a=t.teachers,i=t.students,u=t.responsables):a=t,o.append("Teacher",r.file(a,"enseignants.csv")),i&&o.append("Student",r.file(i,"eleves.csv")),u&&o.append("Relative",r.file(u,"responsables.csv"));const h=d(e);h["Content-Type"]="multipart/form-data; boundary="+o.boundary;const p={headers:h},J=r.post(`${f}/directory/wizard/import`,o.body(),p);l.check(J,{"import structure is ok":K=>K.status==200}),c=S(s,e)}return c}const O=__ENV.ROOT_URL;function $(s,t){let e=r.get(`${O}/appregistry/roles`,{headers:d(t)});return JSON.parse(e.body).filter(o=>o.name===s)[0]}function B(s,t){const e=`${s} - All - Stress Test`;let c=$(e,t);if(c)console.log(`Role ${e} already existed`);else{let o=r.get(`${O}/appregistry/applications/actions?actionType=WORKFLOW`,{headers:d(t)});l.check(o,{"get workflow actions":p=>p.status==200});const i=JSON.parse(o.body).filter(p=>p.name===s)[0].actions.map(p=>p[0]),u=d(t);u["content-type"]="application/json";const h={role:e,actions:i};o=r.post(`${O}/appregistry/role`,JSON.stringify(h),{headers:u}),console.log(o),l.check(o,{"save role ok":p=>p.status==201}),c=$(e,t)}return c}function v(s,t){let e=r.get(`${O}/appregistry/groups/roles?structureId=${s}`,{headers:d(t)});return l.check(e,{"get structure roles should be ok":c=>c.status==200}),JSON.parse(e.body)}n.BASE_URL=b,n.Session=m,n.SessionMode=g,n.activateUsers=N,n.authenticateOAuth2=j,n.authenticateWeb=T,n.createAndSetRole=B,n.createStructure=C,n.getConnectedUserId=I,n.getHeaders=d,n.getMetricValue=w,n.getRoleByName=$,n.getRolesOfStructure=v,n.getSchoolByName=S,n.getUsersOfSchool=A,n.linkRoleToUsers=E,n.searchUser=_,Object.defineProperty(n,Symbol.toStringTag,{value:"Module"})});
